<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Bayesian-Julia/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Bayesian-Julia/libs/highlight/github.min.css"> <link rel=stylesheet  href="/Bayesian-Julia/css/jtd.css"> <link rel=icon  href="/Bayesian-Julia/assets/favicon.ico"> <title>Multilevel Models &#40;a.k.a. Hierarchical Models&#41;</title> <div class=page-wrap > <div class=side-bar > <div class=header > <a href="/Bayesian-Julia/" class=title > Bayesian Stats </a> </div> <label for=show-menu  class=show-menu >MENU</label> <input type=checkbox  id=show-menu  role=button > <div class=menu  id=side-menu > <ul class=menu-list > <li class="menu-list-item "><a href="/Bayesian-Julia/" class="menu-list-link ">Home</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/1_why_Julia/" class="menu-list-link ">1. Why Julia?</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/2_bayes_stats/" class="menu-list-link ">2. What is Bayesian Statistics?</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/3_prob_dist/" class="menu-list-link ">3. Common Probability Distributions</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/4_Turing/" class="menu-list-link ">4. How to use Turing</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/5_MCMC/" class="menu-list-link ">5. Markov Chain Monte Carlo (MCMC)</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/6_linear_reg/" class="menu-list-link ">6. Bayesian Linear Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/7_logistic_reg/" class="menu-list-link ">7. Bayesian Logistic Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/8_count_reg/" class="menu-list-link ">8. Bayesian Regression with Count Data</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/9_robust_reg/" class="menu-list-link ">9. Robust Bayesian Regression</a> <li class="menu-list-item active"><a href="/Bayesian-Julia/pages/10_multilevel_models/" class="menu-list-link active">10. Multilevel Models</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/11_Turing_tricks/" class="menu-list-link ">11. Computational Tricks with Turing</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/12_epi_models/" class="menu-list-link ">12. Bayesian Epidemiological Models</a> </ul> </div> <div class=footer > <a href="https://www.julialang.org"><img style="height:50px;padding-left:10px;margin-bottom:15px;" src="https://julialang.org/assets/infra/logo.svg" alt="Julia Logo"></a> </div> </div> <div class=main-content-wrap > <div class=main-content > <div class=main-header > <a id=github  href="https://github.com/storopoli/Bayesian-Julia">Code on GitHub</a> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-186284914-6"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-186284914-6'); </script> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#when_to_use_multilevel_models">When to use Multilevel Models?</a><li><a href="#hyperpriors">Hyperpriors</a><li><a href="#three_approaches_to_multilevel_models">Three Approaches to Multilevel Models</a><ol><li><a href="#random-intercept_model">Random-Intercept Model</a><li><a href="#random-slope_model">Random-Slope Model</a><li><a href="#random-intercept-slope_model">Random-Intercept-Slope Model</a></ol><li><a href="#example_-_cheese_ratings">Example - Cheese Ratings</a><li><a href="#references">References</a></ol></div> <h1 id=multilevel_models_aka_hierarchical_models ><a href="#multilevel_models_aka_hierarchical_models" class=header-anchor >Multilevel Models &#40;a.k.a. Hierarchical Models&#41;</a></h1> <p>Bayesian hierarchical models &#40;also called multilevel models&#41; are a statistical model written at <em>multiple</em> levels &#40;hierarchical form&#41; that estimates the parameters of the posterior distribution using the Bayesian approach. The sub-models combine to form the hierarchical model, and Bayes&#39; theorem is used to integrate them with the observed data and to account for all the uncertainty that is present. The result of this integration is the posterior distribution, also known as an updated probability estimate, as additional evidence of the likelihood function is integrated together with the prior distribution of the parameters.</p> <p>Hierarchical modeling is used when information is available at several different levels of observation units. The hierarchical form of analysis and organization helps to understand multiparameter problems and also plays an important role in the development of computational strategies.</p> <p>Hierarchical models are mathematical statements that involve several parameters, so that the estimates of some parameters depend significantly on the values of other parameters. The figure below shows a hierarchical model in which there is a <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span> hyperparameter that parameterizes the parameters <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mn>1</mn></msub><mo separator=true >,</mo><msub><mi>θ</mi><mn>2</mn></msub><mo separator=true >,</mo><mo>…</mo><mo separator=true >,</mo><msub><mi>θ</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">\theta_1, \theta_2, \dots, \theta_N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner >…</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> that are finally used to infer the posterior density of some variable of interest <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >y</mi><mo>=</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator=true >,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator=true >,</mo><mo>…</mo><mo separator=true >,</mo><msub><mi>y</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{y} = y_1, y_2, \dots, y_N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner >…</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p> <p><img src="/Bayesian-Julia/pages/images/hierarchical.png" alt="Bayesian Workflow" /></p> <p><div class=text-center ><em>Hierarchical Model</em></div> <br/></p> <h2 id=when_to_use_multilevel_models ><a href="#when_to_use_multilevel_models" class=header-anchor >When to use Multilevel Models?</a></h2> <p>Multilevel models are particularly suitable for research projects where participant data is organized at more than one level, <em>i.e.</em> nested data. Units of analysis are usually individuals &#40;at a lower level&#41; that are nested in contextual/aggregate units &#40;at a higher level&#41;. An example is when we are measuring the performance of individuals and we have additional information about belonging to different groups such as sex, age group, hierarchical level, educational level or housing status.</p> <p>There is a main assumption that cannot be violated in multilevel models which is <strong>exchangeability</strong> &#40;de Finetti, 1974; Nau, 2001&#41;. Yes, this is the same assumption that we discussed in <a href="/Bayesian-Julia/pages/2_bayes_stats/">2. <strong>What is Bayesian Statistics?</strong></a>. This assumption assumes that groups are exchangeable. The figure below shows a graphical representation of the exchangeability. The groups shown as &quot;cups&quot; that contain observations shown as &quot;balls&quot;. If in the model&#39;s inferences, this assumption is violated, then multilevel models are not appropriate. This means that, since there is no theoretical justification to support exchangeability, the inferences of the multilevel model are not robust and the model can suffer from several pathologies and should not be used for any scientific or applied analysis.</p> <p><img src="/Bayesian-Julia/pages/images/exchangeability-1.png" alt="Bayesian Workflow" /> <img src="/Bayesian-Julia/pages/images/exchangeability-2.png" alt="Bayesian Workflow" /></p> <p><div class=text-center ><em>Exchangeability – Images from <a href="https://betanalpha.github.io/">Michael Betancourt</a></em></div> <br/></p> <h2 id=hyperpriors ><a href="#hyperpriors" class=header-anchor >Hyperpriors</a></h2> <p>As the priors of the parameters are sampled from another prior of the hyperparameter &#40;upper-level&#39;s parameter&#41;, which are called <strong>hyperpriors</strong>. This makes one group&#39;s estimates help the model to better estimate the other groups by providing more <strong>robust and stable estimates</strong>.</p> <p>We call the global parameters as <strong>population effects</strong> &#40;or population-level effects, also sometimes called fixed effects&#41; and the parameters of each group as <strong>group effects</strong> &#40;or group-level effects, also sometimes called random effects&#41;. That is why multilevel models are also known as mixed models in which we have both fixed effects and random effects.</p> <h2 id=three_approaches_to_multilevel_models ><a href="#three_approaches_to_multilevel_models" class=header-anchor >Three Approaches to Multilevel Models</a></h2> <p>Multilevel models generally fall into three approaches:</p> <ol> <li><p><strong>Random-intercept model</strong>: each group receives a <strong>different intercept</strong> in addition to the global intercept.</p> <li><p><strong>Random-slope model</strong>: each group receives <strong>different coefficients</strong> for each &#40;or a subset of&#41; independent variable&#40;s&#41; in addition to a global intercept.</p> <li><p><strong>Random-intercept-slope model</strong>: each group receives <strong>both a different intercept and different coefficients</strong> for each independent variable in addition to a global intercept.</p> </ol> <h3 id=random-intercept_model ><a href="#random-intercept_model" class=header-anchor >Random-Intercept Model</a></h3> <p>The first approach is the <strong>random-intercept model</strong> in which we specify a different intercept for each group, in addition to the global intercept. These group-level intercepts are sampled from a hyperprior.</p> <p>To illustrate a multilevel model, I will use the linear regression example with a Gaussian/normal likelihood function. Mathematically a Bayesian multilevel random-slope linear regression model is:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.2500em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi mathvariant=bold >y</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mrow><mo fence=true >(</mo><mi>α</mi><mo>+</mo><msub><mi>α</mi><mi>j</mi></msub><mo>+</mo><mi mathvariant=bold >X</mi><mo>⋅</mo><mi mathvariant=bold-italic >β</mi><mo separator=true >,</mo><mi>σ</mi><mo fence=true >)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>α</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><msub><mi>μ</mi><mi>α</mi></msub><mo separator=true >,</mo><msub><mi>σ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi>α</mi><mi>j</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mi>τ</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi mathvariant=bold-italic >β</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><msub><mi>μ</mi><mi mathvariant=bold-italic >β</mi></msub><mo separator=true >,</mo><msub><mi>σ</mi><mi mathvariant=bold-italic >β</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>τ</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><msup><mtext>Cauchy</mtext><mo>+</mo></msup><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><msub><mi>ψ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>σ</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Exponential</mtext><mo stretchy=false >(</mo><msub><mi>λ</mi><mi>σ</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \mathbf{y} &amp;\sim \text{Normal}\left( \alpha + \alpha_j + \mathbf{X} \cdot \boldsymbol{\beta}, \sigma \right) \\ \alpha &amp;\sim \text{Normal}(\mu_\alpha, \sigma_\alpha) \\ \alpha_j &amp;\sim \text{Normal}(0, \tau) \\ \boldsymbol{\beta} &amp;\sim \text{Normal}(\mu_{\boldsymbol{\beta}}, \sigma_{\boldsymbol{\beta}}) \\ \tau &amp;\sim \text{Cauchy}^+(0, \psi_{\alpha})\\ \sigma &amp;\sim \text{Exponential}(\lambda_\sigma) \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:9.015671000000001em;vertical-align:-4.2578355000000006em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4.7578355000000006em;"><span style="top:-6.917835500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span><span style="top:-5.4178355em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span><span style="top:-3.917835499999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.417835499999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span></span></span><span style="top:-0.9021644999999991em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span><span style="top:0.5978355000000004em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:4.2578355000000006em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4.7578355000000006em;"><span style="top:-6.917835500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">X</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span><span style="top:-5.4178355em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">μ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-3.917835499999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class=mclose >)</span></span></span><span style="top:-2.417835499999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">μ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-0.9021644999999991em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord text"><span class=mord >Cauchy</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ψ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:0.5978355000000004em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Exponential</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">λ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:4.2578355000000006em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>The priors on the global intercept <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span>, global coefficients <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold-italic >β</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\beta}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span></span></span></span> and error <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span>, along with the Gaussian/normal likelihood on <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span> are the same as in the linear regression model. But now we have <strong>new parameters</strong>. The first are the <strong>group intercepts</strong> prior <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_j</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.716668em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> that denotes that every group <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo separator=true >,</mo><mn>2</mn><mo separator=true >,</mo><mo>…</mo><mo separator=true >,</mo><mi>J</mi></mrow><annotation encoding="application/x-tex">1, 2, \dots, J</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class=mord >1</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >2</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner >…</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span></span></span></span> has its own intercept sampled from a normal distribution centered on 0 with a standard deviation <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ψ</mi><mi>α</mi></msub></mrow><annotation encoding="application/x-tex">\psi_\alpha</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ψ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. This group intercept is added to the linear predictor inside the Gaussian/normal likelihood function. The <strong>group intercepts&#39; standard deviation</strong> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span> have a hyperprior &#40;being a prior of a prior&#41; which is sampled from a positive-constrained Cauchy distribution &#40;a special case of the Student-<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> distribution with degrees of freedom <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ν</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\nu = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.06366em;">ν</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>&#41; with mean 0 and standard deviation <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mi>α</mi></msub></mrow><annotation encoding="application/x-tex">\sigma_\alpha</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. This makes the group-level intercept&#39;s dispersions being sampled from the same parameter <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span> which allows the model to use information from one group intercept to infer robust information regarding another group&#39;s intercept dispersion and so on.</p> <p>This is easily accomplished with Turing:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Turing
<span class=hljs-keyword >using</span> Statistics: mean, std
<span class=hljs-keyword >using</span> Random:seed!
seed!(<span class=hljs-number >123</span>)

<span class=hljs-meta >@model</span> varying_intercept(X, idx, y; n_gr=length(unique(idx)), predictors=size(X, <span class=hljs-number >2</span>)) = <span class=hljs-keyword >begin</span>
    <span class=hljs-comment >#priors</span>
    α ~ Normal(mean(y), <span class=hljs-number >2.5</span> * std(y))       <span class=hljs-comment ># population-level intercept</span>
    β ~ filldist(Normal(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>), predictors)  <span class=hljs-comment ># population-level coefficients</span>
    σ ~ Exponential(<span class=hljs-number >1</span> / std(y))             <span class=hljs-comment ># residual SD</span>
    <span class=hljs-comment >#prior for variance of random intercepts</span>
    <span class=hljs-comment >#usually requires thoughtful specification</span>
    τ ~ truncated(Cauchy(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>), <span class=hljs-number >0</span>, <span class=hljs-literal >Inf</span>)     <span class=hljs-comment ># group-level SDs intercepts</span>
    αⱼ ~ filldist(Normal(<span class=hljs-number >0</span>, τ), n_gr)       <span class=hljs-comment ># group-level intercepts</span>

    <span class=hljs-comment >#likelihood</span>
    ŷ = α .+ X * β .+ αⱼ[idx]
    y ~ MvNormal(ŷ, σ)
<span class=hljs-keyword >end</span>;</code></pre> <h3 id=random-slope_model ><a href="#random-slope_model" class=header-anchor >Random-Slope Model</a></h3> <p>The second approach is the <strong>random-slope model</strong> in which we specify a different slope for each group, in addition to the global intercept. These group-level slopes are sampled from a hyperprior.</p> <p>To illustrate a multilevel model, I will use the linear regression example with a Gaussian/normal likelihood function. Mathematically a Bayesian multilevel random-slope linear regression model is:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.2500em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi mathvariant=bold >y</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mrow><mo fence=true >(</mo><mi>α</mi><mo>+</mo><mi mathvariant=bold >X</mi><mo>⋅</mo><msub><mi mathvariant=bold-italic >β</mi><mi>j</mi></msub><mo>⋅</mo><mi mathvariant=bold-italic >τ</mi><mo separator=true >,</mo><mi>σ</mi><mo fence=true >)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>α</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><msub><mi>μ</mi><mi>α</mi></msub><mo separator=true >,</mo><msub><mi>σ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi mathvariant=bold-italic >β</mi><mi>j</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi mathvariant=bold-italic >τ</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><msup><mtext>Cauchy</mtext><mo>+</mo></msup><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><msub><mi>ψ</mi><mi mathvariant=bold-italic >β</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>σ</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Exponential</mtext><mo stretchy=false >(</mo><msub><mi>λ</mi><mi>σ</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \mathbf{y} &amp;\sim \text{Normal}\left( \alpha + \mathbf{X} \cdot \boldsymbol{\beta}_j \cdot \boldsymbol{\tau}, \sigma \right) \\ \alpha &amp;\sim \text{Normal}(\mu_\alpha, \sigma_\alpha) \\ \boldsymbol{\beta}_j &amp;\sim \text{Normal}(0, 1) \\ \boldsymbol{\tau} &amp;\sim \text{Cauchy}^+(0, \psi_{\boldsymbol{\beta}})\\ \sigma &amp;\sim \text{Exponential}(\lambda_\sigma) \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:7.566166999999999em;vertical-align:-3.533083499999999em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4.0330835em;"><span style="top:-6.1830834999999995em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span><span style="top:-4.6628355em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span><span style="top:-3.162835500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.217524em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.380248em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.626916500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.13472em;">τ</span></span></span></span></span><span style="top:-0.126916500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.533083499999999em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4.0330835em;"><span style="top:-6.1830834999999995em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">X</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.217524em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.380248em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.13472em;">τ</span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-4.6628355em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">μ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-3.162835500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >)</span></span></span><span style="top:-1.626916500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord text"><span class=mord >Cauchy</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ψ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-0.126916500000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Exponential</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">λ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.533083499999999em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>Here we have a similar situation from before with the same hyperprior, but now it is a hyperprior for the the group coefficients&#39; standard deviation prior: <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=bold-italic >β</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{\beta}_j</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.0746879999999999em;vertical-align:-0.380248em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.217524em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.380248em;"><span></span></span></span></span></span></span></span></span></span>. This makes the group-level coefficients&#39;s dispersions being sampled from the same parameter <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span> which allows the model to use information from one group coefficients to infer robust information regarding another group&#39;s coefficients dispersion and so on.</p> <p>In Turing we can accomplish this as:</p> <pre><code class="julia hljs"><span class=hljs-meta >@model</span> varying_slope(X, idx, y; n_gr=length(unique(idx)), predictors=size(X, <span class=hljs-number >2</span>)) = <span class=hljs-keyword >begin</span>
    <span class=hljs-comment >#priors</span>
    α ~ Normal(mean(y), <span class=hljs-number >2.5</span> * std(y))                   <span class=hljs-comment ># population-level intercept</span>
    σ ~ Exponential(<span class=hljs-number >1</span> / std(y))                         <span class=hljs-comment ># residual SD</span>
    <span class=hljs-comment >#prior for variance of random slopes</span>
    <span class=hljs-comment >#usually requires thoughtful specification</span>
    τ ~ filldist(truncated(Cauchy(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>), <span class=hljs-number >0</span>, <span class=hljs-literal >Inf</span>), n_gr) <span class=hljs-comment ># group-level slopes SDs</span>
    βⱼ ~ filldist(Normal(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>), predictors, n_gr)       <span class=hljs-comment ># group-level standard normal slopes</span>

    <span class=hljs-comment >#likelihood</span>
    ŷ = α .+ X * βⱼ * τ
    y ~ MvNormal(ŷ, σ)
<span class=hljs-keyword >end</span>;</code></pre> <h3 id=random-intercept-slope_model ><a href="#random-intercept-slope_model" class=header-anchor >Random-Intercept-Slope Model</a></h3> <p>The third approach is the <strong>random-slope model</strong> in which we specify a different intercept and slope for each group, in addition to the global intercept. These group-level intercepts and slopes are sampled from hyperpriors.</p> <p>To illustrate a multilevel model, I will use the linear regression example with a Gaussian/normal likelihood function. Mathematically a Bayesian multilevel random-intercept-slope linear regression model is:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.2500em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi mathvariant=bold >y</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mrow><mo fence=true >(</mo><mi>α</mi><mo>+</mo><msub><mi>α</mi><mi>j</mi></msub><mo>+</mo><mi mathvariant=bold >X</mi><mo>⋅</mo><msub><mi mathvariant=bold-italic >β</mi><mi>j</mi></msub><mo>⋅</mo><msub><mi mathvariant=bold-italic >τ</mi><mi mathvariant=bold-italic >β</mi></msub><mo separator=true >,</mo><mi>σ</mi><mo fence=true >)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>α</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><msub><mi>μ</mi><mi>α</mi></msub><mo separator=true >,</mo><msub><mi>σ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi>α</mi><mi>j</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><msub><mi>τ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi mathvariant=bold-italic >β</mi><mi>j</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Normal</mtext><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi>τ</mi><mi>α</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><msup><mtext>Cauchy</mtext><mo>+</mo></msup><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><msub><mi>ψ</mi><mi>α</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi mathvariant=bold-italic >τ</mi><mi mathvariant=bold-italic >β</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><msup><mtext>Cauchy</mtext><mo>+</mo></msup><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><msub><mi>ψ</mi><mi mathvariant=bold-italic >β</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mi>σ</mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>∼</mo><mtext>Exponential</mtext><mo stretchy=false >(</mo><msub><mi>λ</mi><mi>σ</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \mathbf{y} &amp;\sim \text{Normal}\left( \alpha + \alpha_j + \mathbf{X} \cdot \boldsymbol{\beta}_j \cdot \boldsymbol{\tau}_{\boldsymbol{\beta}}, \sigma \right) \\ \alpha &amp;\sim \text{Normal}(\mu_\alpha, \sigma_\alpha) \\ \alpha_j &amp;\sim \text{Normal}(0, \tau_{\alpha}) \\ \boldsymbol{\beta}_j &amp;\sim \text{Normal}(0, 1) \\ \tau_{\alpha} &amp;\sim \text{Cauchy}^+(0, \psi_{\alpha})\\ \boldsymbol{\tau}_{\boldsymbol{\beta}} &amp;\sim \text{Cauchy}^+(0, \psi_{\boldsymbol{\beta}})\\ \sigma &amp;\sim \text{Exponential}(\lambda_\sigma) \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:10.581838em;vertical-align:-5.040918999999999em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:5.540919000000001em;"><span style="top:-7.690919em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span><span style="top:-6.1706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span><span style="top:-4.6706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.1706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.217524em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.380248em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.6347520000000006em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.11908100000000132em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.13472em;">τ</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:1.3809189999999987em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:5.040918999999999em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:5.540919000000001em;"><span style="top:-7.690919em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">X</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.217524em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.380248em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.13472em;">τ</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-6.1706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">μ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-4.6706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-3.1706710000000005em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Normal</span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >)</span></span></span><span style="top:-1.6347520000000006em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord text"><span class=mord >Cauchy</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ψ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-0.11908100000000132em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord text"><span class=mord >Cauchy</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ψ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03403em;">β</span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:1.3809189999999987em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >Exponential</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">λ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:5.040918999999999em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>Here we have a similar situation from before with the same hyperpriors, but now we fused both random-intercept and random-slope together.</p> <p>In Turing we can accomplish this as:</p> <pre><code class="julia hljs"><span class=hljs-meta >@model</span> varying_intercept_slope(X, idx, y; n_gr=length(unique(idx)), predictors=size(X, <span class=hljs-number >2</span>)) = <span class=hljs-keyword >begin</span>
    <span class=hljs-comment >#priors</span>
    α ~ Normal(mean(y), <span class=hljs-number >2.5</span> * std(y))                    <span class=hljs-comment ># population-level intercept</span>
    σ ~ Exponential(<span class=hljs-number >1</span> / std(y))                          <span class=hljs-comment ># residual SD</span>
    <span class=hljs-comment >#prior for variance of random intercepts and slopes</span>
    <span class=hljs-comment >#usually requires thoughtful specification</span>
    τₐ ~ truncated(Cauchy(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>), <span class=hljs-number >0</span>, <span class=hljs-literal >Inf</span>)                 <span class=hljs-comment ># group-level SDs intercepts</span>
    τᵦ ~ filldist(truncated(Cauchy(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>), <span class=hljs-number >0</span>, <span class=hljs-literal >Inf</span>), n_gr) <span class=hljs-comment ># group-level slopes SDs</span>
    αⱼ ~ filldist(Normal(<span class=hljs-number >0</span>, τₐ), n_gr)                   <span class=hljs-comment ># group-level intercepts</span>
    βⱼ ~ filldist(Normal(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>), predictors, n_gr)        <span class=hljs-comment ># group-level standard normal slopes</span>

    <span class=hljs-comment >#likelihood</span>
    ŷ = α .+ αⱼ[idx] .+ X * βⱼ * τᵦ
    y ~ MvNormal(ŷ, σ)
<span class=hljs-keyword >end</span>;</code></pre> <h2 id=example_-_cheese_ratings ><a href="#example_-_cheese_ratings" class=header-anchor >Example - Cheese Ratings</a></h2> <p>For our example, I will use a famous dataset called <code>cheese</code> &#40;Boatwright, McCulloch &amp; Rossi, 1999&#41;, which is data from cheese ratings. A group of 10 rural and 10 urban raters rated 4 types of different cheeses &#40;A, B, C and D&#41; in two samples. So we have <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>⋅</mo><mn>20</mn><mo>⋅</mo><mn>2</mn><mo>=</mo><mn>160</mn></mrow><annotation encoding="application/x-tex">4 \cdot 20 \cdot2 = 160</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >4</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >20</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >2</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >160</span></span></span></span> observations and 4 variables:</p> <ul> <li><p><code>cheese</code>: type of cheese from <code>A</code> to <code>D</code></p> <li><p><code>rater</code>: id of the rater from <code>1</code> to <code>10</code></p> <li><p><code>background</code>: type of rater, either <code>rural</code> or <code>urban</code></p> <li><p><code>y</code>: rating of the cheese</p> </ul> <p>Ok let&#39;s read our data with <code>CSV.jl</code> and output into a <code>DataFrame</code> from <code>DataFrames.jl</code>:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> DataFrames, CSV, HTTP

url = <span class=hljs-string >&quot;https://raw.githubusercontent.com/storopoli/Bayesian-Julia/master/datasets/cheese.csv&quot;</span>
cheese = CSV.read(HTTP.get(url).body, DataFrame)
describe(cheese)</code></pre><pre><code class="plaintext hljs">4×7 DataFrame
 Row │ variable    mean     min    median  max    nmissing  eltype
     │ Symbol      Union…   Any    Union…  Any    Int64     DataType
─────┼───────────────────────────────────────────────────────────────
   1 │ cheese               A              D             0  String
   2 │ rater       5.5      1      5.5     10            0  Int64
   3 │ background           rural          urban         0  String
   4 │ y           70.8438  33     71.5    91            0  Int64</code></pre> <p>As you can see from the <code>describe&#40;&#41;</code> output, the mean cheese ratings is around 70 ranging from 33 to 91.</p> <p>In order to prepare the data for Turing, I will convert the <code>String</code>s in variables <code>cheese</code> and <code>background</code> to <code>Int</code>s. Regarding <code>cheese</code>, I will create 4 dummy variables one for each cheese type; and <code>background</code> will be converted to integer data taking two values: one for each background type. My intent is to model <code>background</code> as a group both for intercept and coefficients. Take a look at how the data will look like for the first 5 observations:</p> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> unique(cheese[:, :cheese])
    cheese[:, <span class=hljs-string >&quot;cheese_<span class=hljs-variable >$c</span>&quot;</span>] = ifelse.(cheese[:, :cheese] .== c, <span class=hljs-number >1</span>, <span class=hljs-number >0</span>)
<span class=hljs-keyword >end</span>

cheese[:, :background_int] = map(cheese[:, :background]) <span class=hljs-keyword >do</span> b
    b == <span class=hljs-string >&quot;rural&quot;</span> ? <span class=hljs-number >1</span> :
    b == <span class=hljs-string >&quot;urban&quot;</span> ? <span class=hljs-number >2</span> : <span class=hljs-literal >missing</span>
<span class=hljs-keyword >end</span>

first(cheese, <span class=hljs-number >5</span>)</code></pre><pre><code class="plaintext hljs">5×9 DataFrame
 Row │ cheese  rater  background  y      cheese_A  cheese_B  cheese_C  cheese_D  background_int
     │ String  Int64  String      Int64  Int64     Int64     Int64     Int64     Int64
─────┼──────────────────────────────────────────────────────────────────────────────────────────
   1 │ A           1  rural          67         1         0         0         0               1
   2 │ A           1  rural          66         1         0         0         0               1
   3 │ B           1  rural          51         0         1         0         0               1
   4 │ B           1  rural          53         0         1         0         0               1
   5 │ C           1  rural          75         0         0         1         0               1</code></pre> <p>Now let&#39;s us instantiate our model with the data. Here, I will specify a vector of <code>Int</code>s named <code>idx</code> to represent the different observations&#39; group memberships. This will be used by Turing when we index a parameter with the <code>idx</code>, <em>e.g.</em> <code>αⱼ&#91;idx&#93;</code>.</p> <pre><code class="julia hljs">X = <span class=hljs-built_in >Matrix</span>(select(cheese, Between(:cheese_A, :cheese_D)));
y = cheese[:, :y];
idx = cheese[:, :background_int];</code></pre> <p>The first model is the <code>varying_intercept</code>:</p> <pre><code class="julia hljs">model_intercept = varying_intercept(X, idx, y)
chain_intercept = sample(model_intercept, NUTS(), MCMCThreads(), <span class=hljs-number >2_000</span>, <span class=hljs-number >4</span>)
summarystats(chain_intercept)  |&gt; DataFrame  |&gt; println</code></pre><pre><code class="plaintext hljs">9×8 DataFrame
 Row │ parameters  mean       std       naive_se    mcse        ess      rhat     ess_per_sec
     │ Symbol      Float64    Float64   Float64     Float64     Float64  Float64  Float64
─────┼────────────────────────────────────────────────────────────────────────────────────────
   1 │ α            70.7684   5.48791   0.0613567   0.177144    1036.9   1.0082       27.5506
   2 │ β[1]          3.21779  1.24011   0.0138648   0.0183512   3902.97  1.00073     103.703
   3 │ β[2]        -11.628    1.28267   0.0143407   0.0191741   3753.33  1.00012      99.7271
   4 │ β[3]          7.13598  1.25794   0.0140641   0.0188506   4028.54  1.00032     107.04
   5 │ β[4]          1.19319  1.25332   0.0140125   0.0188195   3810.19  1.00096     101.238
   6 │ σ             6.00727  0.273516  0.00305801  0.00341672  5640.23  1.00037     149.863
   7 │ τ             6.65784  7.6016    0.0849884   0.21169     1402.58  1.00412      37.267
   8 │ αⱼ[1]        -3.49322  5.38098   0.0601612   0.175903    1023.59  1.00857      27.197
   9 │ αⱼ[2]         3.68118  5.38234   0.0601764   0.175645    1028.1   1.00854      27.317
</code></pre> <p>Here we can see that the model has a population-level intercept <code>α</code> along with population-level coefficients <code>β</code>s for each <code>cheese</code> dummy variable. But notice that we have also group-level intercepts for each of the groups <code>αⱼ</code>s. Specifically, <code>αⱼ&#91;1&#93;</code> are the rural raters and <code>αⱼ&#91;2&#93;</code> are the urban raters.</p> <p>Now let&#39;s go to the second model, <code>varying_slope</code>:</p> <pre><code class="julia hljs">model_slope = varying_slope(X, idx, y)
chain_slope = sample(model_slope, NUTS(), MCMCThreads(), <span class=hljs-number >2_000</span>, <span class=hljs-number >4</span>)
summarystats(chain_slope)  |&gt; DataFrame  |&gt; println</code></pre><pre><code class="plaintext hljs">12×8 DataFrame
 Row │ parameters  mean        std       naive_se    mcse        ess       rhat     ess_per_sec
     │ Symbol      Float64     Float64   Float64     Float64     Float64   Float64  Float64
─────┼──────────────────────────────────────────────────────────────────────────────────────────
   1 │ α           70.5272     5.14562   0.0575298   0.178169     653.629  1.0033       5.99952
   2 │ σ            6.52962    0.283214  0.00316642  0.00639165  1848.47   1.00203     16.9667
   3 │ τ[1]         6.301      5.15761   0.0576639   0.184247     684.491  1.00809      6.28279
   4 │ τ[2]         6.24085    5.71732   0.0639216   0.31856      172.062  1.02051      1.57932
   5 │ βⱼ[1,1]      0.283791   0.815655  0.0091193   0.0218421   1705.59   1.00149     15.6552
   6 │ βⱼ[2,1]     -0.901693   1.05626   0.0118094   0.0325995    891.973  1.00528      8.18722
   7 │ βⱼ[3,1]      0.632231   0.871581  0.00974457  0.0190019   2048.0    1.00215     18.7981
   8 │ βⱼ[4,1]      0.120313   0.775049  0.00866531  0.0195576   1841.14   1.0025      16.8994
   9 │ βⱼ[1,2]      0.236236   0.808539  0.00903974  0.0150141   3236.28   1.00145     29.7051
  10 │ βⱼ[2,2]     -0.903018   1.02939   0.0115089   0.021997    1828.67   1.00089     16.7849
  11 │ βⱼ[3,2]      0.546223   0.882609  0.00986787  0.0201472   1881.99   1.00255     17.2744
  12 │ βⱼ[4,2]      0.0899406  0.81561   0.00911879  0.0196982   2274.55   1.00224     20.8776
</code></pre> <p>Here we can see that the model has still a population-level intercept <code>α</code>. But now our population-level coefficients <code>β</code>s are replaced by group-level coefficients <code>βⱼ</code>s along with their standard deviation <code>τᵦ</code>s. Specifically <code>βⱼ</code>&#39;s first index denotes the 4 dummy <code>cheese</code> variables&#39; and the second index are the group membership. So, for example <code>βⱼ&#91;1,1&#93;</code> is the coefficient for <code>cheese_A</code> and rural raters &#40;group 1&#41;.</p> <p>Now let&#39;s go to the third model, <code>varying_intercept_slope</code>:</p> <pre><code class="julia hljs">model_intercept_slope = varying_intercept_slope(X, idx, y)
chain_intercept_slope = sample(model_intercept_slope, NUTS(), MCMCThreads(), <span class=hljs-number >2_000</span>, <span class=hljs-number >4</span>)
summarystats(chain_intercept_slope)  |&gt; DataFrame  |&gt; println</code></pre><pre><code class="plaintext hljs">15×8 DataFrame
 Row │ parameters  mean        std       naive_se    mcse        ess       rhat      ess_per_sec
     │ Symbol      Float64     Float64   Float64     Float64     Float64   Float64   Float64
─────┼───────────────────────────────────────────────────────────────────────────────────────────
   1 │ α           70.4457     7.54367   0.0843408   0.168581    1422.27   1.00145       6.69497
   2 │ σ            5.88023    0.258276  0.00288761  0.00290252  7933.77   1.00046      37.3463
   3 │ τₐ           6.48589    6.79739   0.0759971   0.190206    1675.39   1.00333       7.8865
   4 │ τᵦ[1]        6.17748    5.27152   0.0589373   0.15003     1381.08   1.00398       6.5011
   5 │ τᵦ[2]        6.3886     5.41904   0.0605867   0.150542    1282.92   1.00359       6.03904
   6 │ αⱼ[1]       -3.25045    5.64181   0.0630774   0.137273     990.726  1.00117       4.6636
   7 │ αⱼ[2]        3.92342    5.63955   0.063052    0.137561     979.702  1.00115       4.61171
   8 │ βⱼ[1,1]      0.271351   0.808807  0.00904274  0.0138439   4288.83   1.00104      20.1886
   9 │ βⱼ[2,1]     -0.888729   1.04732   0.0117094   0.0244363   2088.32   1.00196       9.83024
  10 │ βⱼ[3,1]      0.552008   0.894551  0.0100014   0.0176826   2518.93   1.00101      11.8572
  11 │ βⱼ[4,1]      0.0926366  0.797148  0.00891238  0.0118159   4478.14   1.0005       21.0797
  12 │ βⱼ[1,2]      0.247501   0.801304  0.00895885  0.0107671   4863.67   1.00066      22.8945
  13 │ βⱼ[2,2]     -0.906415   1.03314   0.0115508   0.022167    2114.98   1.00132       9.95573
  14 │ βⱼ[3,2]      0.548591   0.875582  0.0097893   0.0141286   2952.3    1.00186      13.8972
  15 │ βⱼ[4,2]      0.0995871  0.762932  0.00852984  0.00972179  5563.58   0.999855     26.1892
</code></pre> <p>Now we have fused the previous model in one. We still have a population-level intercept <code>α</code>. But now we have in the same model group-level intercepts for each of the groups <code>αⱼ</code>s and group-level along with their standard deviation <code>τₐ</code>. We also have the coefficients <code>βⱼ</code>s with their standard deviation <code>τᵦ</code>s. The parameters are interpreted exactly as the previous cases.</p> <h2 id=references ><a href="#references" class=header-anchor >References</a></h2> <p>Boatwright, P., McCulloch, R., &amp; Rossi, P. &#40;1999&#41;. Account-level modeling for trade promotion: An application of a constrained parameter hierarchical model. Journal of the American Statistical Association, 94&#40;448&#41;, 1063–1073.</p> <p>de Finetti, B. &#40;1974&#41;. Theory of Probability &#40;Volume 1&#41;. New York: John Wiley &amp; Sons.</p> <p>Nau, R. F. &#40;2001&#41;. De Finetti was Right: Probability Does Not Exist. Theory and Decision, 51&#40;2&#41;, 89–124. https://doi.org/10.1023/A:1015525808214</p> <div class=page-foot > <div class=copyright > Last modified: June 20, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> </div> <!-- end of class page-wrap-->